-- ==========================================
-- ğŸ¨ ë°”ì´ë¸Œì½”ë”© ì‘í’ˆ ì—…ë¡œë“œ ê¸°ëŠ¥ ì„¤ì •
-- ==========================================
-- 
-- ğŸ“‹ ì‚¬ìš© ë°©ë²•:
-- 1. Supabase ëŒ€ì‹œë³´ë“œ ì ‘ì†
-- 2. ì™¼ìª½ ë©”ë‰´ì—ì„œ "SQL Editor" í´ë¦­
-- 3. ì´ íŒŒì¼ì˜ ì „ì²´ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°
-- 4. "Run" ë²„íŠ¼ í´ë¦­
-- 
-- ==========================================

-- ==========================================
-- 1ï¸âƒ£ artworks í…Œì´ë¸” ìƒì„± (ì‘í’ˆ ê²Œì‹œë¬¼)
-- ==========================================
CREATE TABLE IF NOT EXISTS artworks (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    image_url TEXT, -- NULL í—ˆìš© (ììœ ê²Œì‹œíŒ í…ìŠ¤íŠ¸ ì „ìš© ê²Œì‹œë¬¼ ì§€ì›)
    author_nickname TEXT,
    author_email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- user_idì— ì¸ë±ìŠ¤ ìƒì„± (ë¹ ë¥¸ ì¡°íšŒ)
CREATE INDEX IF NOT EXISTS artworks_user_id_idx ON artworks(user_id);

-- created_atì— ì¸ë±ìŠ¤ ìƒì„± (ìµœì‹ ìˆœ ì •ë ¬)
CREATE INDEX IF NOT EXISTS artworks_created_at_idx ON artworks(created_at DESC);

-- ==========================================
-- 2ï¸âƒ£ RLS (Row Level Security) í™œì„±í™”
-- ==========================================
ALTER TABLE artworks ENABLE ROW LEVEL SECURITY;

-- ==========================================
-- 3ï¸âƒ£ artworks í…Œì´ë¸” ë³´ì•ˆ ì •ì±…
-- ==========================================
-- ê¸°ì¡´ ì •ì±… ì‚­ì œ
DROP POLICY IF EXISTS "Anyone can read artworks" ON artworks;
DROP POLICY IF EXISTS "Authenticated users can create artworks" ON artworks;
DROP POLICY IF EXISTS "Users can update own artworks" ON artworks;
DROP POLICY IF EXISTS "Users can delete own artworks" ON artworks;

-- ëˆ„êµ¬ë‚˜ ì‘í’ˆ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Anyone can read artworks" ON artworks
    FOR SELECT USING (true);

-- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì‘í’ˆ ìƒì„± ê°€ëŠ¥
CREATE POLICY "Authenticated users can create artworks" ON artworks
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ë³¸ì¸ ì‘í’ˆë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own artworks" ON artworks
    FOR UPDATE USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

-- ë³¸ì¸ ì‘í’ˆë§Œ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can delete own artworks" ON artworks
    FOR DELETE USING (auth.uid() = user_id);

-- ==========================================
-- 4ï¸âƒ£ updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±°
-- ==========================================
-- íŠ¸ë¦¬ê±° í•¨ìˆ˜ëŠ” ì´ë¯¸ ì¡´ì¬í•œë‹¤ê³  ê°€ì • (SETUP_DATABASE.sqlì—ì„œ ìƒì„±ë¨)
-- ì—†ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì—¬ ìƒì„±
/*
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
*/

-- artworks í…Œì´ë¸” íŠ¸ë¦¬ê±°
DROP TRIGGER IF EXISTS update_artworks_updated_at ON artworks;
CREATE TRIGGER update_artworks_updated_at
    BEFORE UPDATE ON artworks
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ==========================================
-- 5ï¸âƒ£ Storage ë²„í‚· ìƒì„± (ì‘í’ˆ ì´ë¯¸ì§€ìš©)
-- ==========================================
-- posts ë²„í‚· ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
INSERT INTO storage.buckets (id, name, public)
VALUES ('posts', 'posts', true)
ON CONFLICT (id) DO NOTHING;

-- posts ë²„í‚· ì •ì±…: ëˆ„êµ¬ë‚˜ ì½ê¸° ê°€ëŠ¥
DROP POLICY IF EXISTS "Anyone can view posts" ON storage.objects;
CREATE POLICY "Anyone can view posts"
ON storage.objects FOR SELECT
USING (bucket_id = 'posts');

-- posts ë²„í‚· ì •ì±…: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì—…ë¡œë“œ ê°€ëŠ¥
DROP POLICY IF EXISTS "Authenticated users can upload posts" ON storage.objects;
CREATE POLICY "Authenticated users can upload posts"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'posts' AND auth.role() = 'authenticated');

-- posts ë²„í‚· ì •ì±…: ë³¸ì¸ íŒŒì¼ë§Œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
DROP POLICY IF EXISTS "Users can update own posts" ON storage.objects;
CREATE POLICY "Users can update own posts"
ON storage.objects FOR UPDATE
USING (bucket_id = 'posts' AND auth.uid()::text = (storage.foldername(name))[1]);

-- posts ë²„í‚· ì •ì±…: ë³¸ì¸ íŒŒì¼ë§Œ ì‚­ì œ ê°€ëŠ¥
DROP POLICY IF EXISTS "Users can delete own posts" ON storage.objects;
CREATE POLICY "Users can delete own posts"
ON storage.objects FOR DELETE
USING (bucket_id = 'posts' AND auth.uid()::text = (storage.foldername(name))[1]);

-- ==========================================
-- 6ï¸âƒ£ ìŠ¤í‚¤ë§ˆ ìºì‹œ ê°•ì œ ê°±ì‹ 
-- ==========================================
NOTIFY pgrst, 'reload schema';

-- artworks í…Œì´ë¸” êµ¬ì¡° í™•ì¸
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns 
WHERE table_name = 'artworks' 
ORDER BY ordinal_position;

-- ==========================================
-- âœ… ì„¤ì • ì™„ë£Œ!
-- ==========================================
-- 
-- ğŸ“Š ìƒì„±ëœ í…Œì´ë¸”:
-- - artworks (ì‘í’ˆ ê²Œì‹œë¬¼: title, description, image_url [NULL í—ˆìš©])
--
-- ğŸ—‚ï¸ Storage ë²„í‚·:
-- - posts (ì‘í’ˆ ì´ë¯¸ì§€ ì €ì¥ì†Œ)
--
-- ğŸ”’ ë³´ì•ˆ ì •ì±… (RLS) ì ìš©ë¨
-- âš¡ ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì ìš©ë¨
-- ğŸ”„ ìŠ¤í‚¤ë§ˆ ìºì‹œ ê°±ì‹ ë¨
--
-- ğŸ’¡ ì‹¤í–‰ í›„ artworks í…Œì´ë¸”ì˜ ì»¬ëŸ¼ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.
--
-- ==========================================
