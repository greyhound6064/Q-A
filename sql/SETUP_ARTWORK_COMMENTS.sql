-- ==========================================
-- ğŸ¨ ì‘í’ˆ ëŒ“ê¸€ ì‹œìŠ¤í…œ ì„¤ì •
-- ==========================================
-- 
-- ğŸ“‹ ì‚¬ìš© ë°©ë²•:
-- 1. Supabase ëŒ€ì‹œë³´ë“œ ì ‘ì†
-- 2. ì™¼ìª½ ë©”ë‰´ì—ì„œ "SQL Editor" í´ë¦­
-- 3. ì´ íŒŒì¼ì˜ ì „ì²´ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°
-- 4. "Run" ë²„íŠ¼ í´ë¦­
-- 
-- ==========================================

-- ==========================================
-- 1ï¸âƒ£ artwork_comments í…Œì´ë¸” ìƒì„±
-- ==========================================
CREATE TABLE IF NOT EXISTS artwork_comments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    artwork_id BIGINT NOT NULL REFERENCES artworks(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    author_nickname TEXT,
    author_email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ìƒì„± (ë¹ ë¥¸ ì¡°íšŒ)
CREATE INDEX IF NOT EXISTS artwork_comments_artwork_id_idx ON artwork_comments(artwork_id);
CREATE INDEX IF NOT EXISTS artwork_comments_user_id_idx ON artwork_comments(user_id);
CREATE INDEX IF NOT EXISTS artwork_comments_created_at_idx ON artwork_comments(created_at DESC);

-- ==========================================
-- 2ï¸âƒ£ RLS (Row Level Security) í™œì„±í™”
-- ==========================================
ALTER TABLE artwork_comments ENABLE ROW LEVEL SECURITY;

-- ==========================================
-- 3ï¸âƒ£ artwork_comments ë³´ì•ˆ ì •ì±…
-- ==========================================
-- ê¸°ì¡´ ì •ì±… ì‚­ì œ
DROP POLICY IF EXISTS "Anyone can read artwork comments" ON artwork_comments;
DROP POLICY IF EXISTS "Authenticated users can create artwork comments" ON artwork_comments;
DROP POLICY IF EXISTS "Users can update own artwork comments" ON artwork_comments;
DROP POLICY IF EXISTS "Users can delete own artwork comments" ON artwork_comments;

-- ìƒˆë¡œìš´ ì •ì±… ìƒì„±
-- ëˆ„êµ¬ë‚˜ ëŒ“ê¸€ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Anyone can read artwork comments" 
ON artwork_comments FOR SELECT 
USING (true);

-- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥
CREATE POLICY "Authenticated users can create artwork comments" 
ON artwork_comments FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- ë³¸ì¸ ëŒ“ê¸€ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own artwork comments" 
ON artwork_comments FOR UPDATE 
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can delete own artwork comments" 
ON artwork_comments FOR DELETE 
USING (auth.uid() = user_id);

-- ==========================================
-- 4ï¸âƒ£ updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±°
-- ==========================================
DROP TRIGGER IF EXISTS update_artwork_comments_updated_at ON artwork_comments;
CREATE TRIGGER update_artwork_comments_updated_at
    BEFORE UPDATE ON artwork_comments
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ==========================================
-- 5ï¸âƒ£ ëŒ“ê¸€ ìˆ˜ ì§‘ê³„ í•¨ìˆ˜ (ì„ íƒì‚¬í•­)
-- ==========================================
-- íŠ¹ì • ì‘í’ˆì˜ ëŒ“ê¸€ ìˆ˜ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_artwork_comment_count(artwork_bigint BIGINT)
RETURNS INTEGER AS $$
    SELECT COUNT(*)::INTEGER FROM artwork_comments WHERE artwork_id = artwork_bigint;
$$ LANGUAGE SQL STABLE;

-- ==========================================
-- âœ… ì„¤ì • ì™„ë£Œ!
-- ==========================================
-- 
-- ğŸ“Š ìƒì„±ëœ í…Œì´ë¸”:
-- - artwork_comments (ì‘í’ˆ ëŒ“ê¸€)
--
-- ğŸ”’ ë³´ì•ˆ ì •ì±… (RLS) ì ìš©ë¨
-- âš¡ ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì ìš©ë¨
-- ğŸ“ˆ ì¸ë±ìŠ¤ ìƒì„±ë¨
--
-- ==========================================
