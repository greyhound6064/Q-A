# 변경 사항: 닉네임 변경 제한 시스템

## 📅 업데이트 날짜
2026-01-26

## 🎯 버전
5.9.5

## 📝 변경 내용

### 새로운 기능
닉네임 변경을 **30일 동안 최대 2번**으로 제한하는 시스템 추가

---

## 🗂️ 변경된 파일

### 1. 새로 추가된 파일

#### SQL
- `sql/ADD_NICKNAME_CHANGE_LIMIT.sql`
  - 닉네임 변경 이력 테이블 생성
  - 변경 제한 확인 함수 생성
  - 자동 기록 트리거 설정
  - RLS 정책 설정

- `sql/README_NICKNAME_LIMIT.md`
  - 설치 및 사용 가이드
  - 문제 해결 방법
  - SQL 쿼리 예시

### 2. 수정된 파일

#### JavaScript
- `js/profile.js`
  - `saveProfileChanges()`: 닉네임 변경 시 제한 확인 로직 추가
  - `openProfileEditModal()`: 변경 제한 정보 표시 추가
  - `displayNicknameChangeLimit()`: 새 함수 추가 - 변경 가능 횟수 및 안내 표시

#### CSS
- `css/profile.css`
  - `.nickname-change-notice`: 안내 문구 컨테이너 스타일
  - `.notice-info`: 정보 안내 스타일 (파란색)
  - `.notice-warning`: 경고 안내 스타일 (주황색)
  - `.notice-error`: 오류 안내 스타일 (빨간색)

#### 문서
- `프로젝트 구조/ARCHITECTURE.md`
  - 버전 업데이트: 5.9.4 → 5.9.5
  - 프로필 기능 설명에 닉네임 변경 제한 추가
  - 데이터베이스 스키마에 `nickname_change_history` 테이블 추가
  - SQL 파일 목록 업데이트 (20개 → 21개)

---

## 🔧 기술적 구현

### 데이터베이스 레벨
1. **nickname_change_history 테이블**
   - 모든 닉네임 변경 이력 저장
   - user_id, old_nickname, new_nickname, changed_at

2. **check_nickname_change_limit() 함수**
   - 최근 30일 내 변경 횟수 조회
   - 남은 변경 가능 횟수 계산
   - 다음 변경 가능 날짜 계산
   - 최근 변경 이력 반환

3. **트리거**
   - profiles 테이블의 nickname 변경 시 자동 실행
   - 변경 제한 확인 후 초과 시 에러 발생
   - 변경 이력 자동 기록

### 애플리케이션 레벨
1. **프로필 편집 모달**
   - 모달 열 때 변경 가능 횟수 표시
   - 변경 불가능 시 입력 필드 비활성화
   - 실시간 안내 문구 표시

2. **저장 시 검증**
   - 닉네임이 실제로 변경된 경우에만 제한 확인
   - 변경 불가능 시 상세한 안내 메시지 표시
   - 마지막 변경 기회 시 확인 다이얼로그 표시

---

## 🎨 사용자 경험

### 변경 가능 상태 (0번 변경)
```
ℹ️ 닉네임은 30일 동안 최대 2번까지 변경할 수 있습니다.
```
- 파란색 안내 박스
- 정보 아이콘 표시
- 입력 필드 활성화

### 변경 가능 상태 (1번 변경)
```
⚠️ 최근 30일 내 1번 변경했습니다. 1번의 변경 기회가 남았습니다.
```
- 주황색 경고 박스
- 경고 아이콘 표시
- 입력 필드 활성화
- 저장 시 확인 다이얼로그 추가

### 변경 불가능 상태 (2번 변경)
```
❌ 닉네임 변경 불가
30일 내 2번 변경 제한에 도달했습니다.
다음 변경 가능 날짜: 2026년 2월 25일 오후 3:30
```
- 빨간색 오류 박스
- 오류 아이콘 표시
- 입력 필드 비활성화 (회색 처리)
- 다음 변경 가능 날짜 명시

---

## 📋 설치 방법

### 1. SQL 실행
1. Supabase 대시보드 → SQL Editor
2. `sql/ADD_NICKNAME_CHANGE_LIMIT.sql` 파일 내용 복사
3. 붙여넣기 후 실행

### 2. 코드 배포
- 수정된 JavaScript 및 CSS 파일 배포
- 브라우저 캐시 클리어 권장

### 3. 테스트
1. 프로필 편집 모달 열기
2. 안내 문구 표시 확인
3. 닉네임 변경 후 제한 확인

---

## 🔍 테스트 시나리오

### 시나리오 1: 첫 변경
1. 프로필 편집 모달 열기
2. 파란색 안내 문구 확인: "30일 동안 최대 2번까지 변경 가능"
3. 닉네임 변경 후 저장
4. 성공적으로 변경됨

### 시나리오 2: 두 번째 변경
1. 프로필 편집 모달 열기
2. 주황색 경고 문구 확인: "1번 변경, 1번 남음"
3. 닉네임 변경 시도
4. 확인 다이얼로그 표시
5. 확인 후 변경 완료

### 시나리오 3: 제한 도달
1. 프로필 편집 모달 열기
2. 빨간색 오류 문구 확인: "변경 불가, 다음 가능 날짜: ..."
3. 닉네임 입력 필드 비활성화 확인
4. 저장 버튼 클릭해도 변경 불가

---

## 🛡️ 보안 및 안정성

### 데이터베이스 레벨 보호
- 트리거를 통한 자동 검증
- 직접적인 SQL 조작으로도 제한 우회 불가능
- RLS 정책으로 다른 사용자 이력 조회 차단

### 애플리케이션 레벨 검증
- 저장 전 클라이언트 측 검증
- 사용자 친화적인 오류 메시지
- 실시간 안내 문구 표시

### 이중 검증
1. 클라이언트: 저장 버튼 클릭 시
2. 서버(DB): 트리거에서 최종 검증

---

## 📊 데이터 구조

### nickname_change_history 테이블
```sql
{
    id: UUID,
    user_id: UUID,
    old_nickname: TEXT,
    new_nickname: TEXT,
    changed_at: TIMESTAMPTZ,
    created_at: TIMESTAMPTZ
}
```

### check_nickname_change_limit() 반환값
```javascript
{
    change_count: 1,              // 최근 30일 변경 횟수
    remaining_changes: 1,         // 남은 변경 가능 횟수
    next_available_date: null,    // 다음 변경 가능 날짜
    can_change: true,             // 변경 가능 여부
    recent_changes: [...]         // 최근 변경 이력
}
```

---

## 🔄 향후 개선 가능 사항

1. **관리자 기능**
   - 특정 사용자의 제한 초기화
   - 변경 이력 조회 대시보드

2. **알림 시스템**
   - 변경 가능 날짜 도래 시 알림
   - 이메일 알림 옵션

3. **통계**
   - 전체 사용자의 닉네임 변경 패턴 분석
   - 제한 도달 사용자 통계

---

## 📞 문의

기술적 문제나 질문이 있으시면 프로젝트 관리자에게 문의해주세요.

---

## ✅ 체크리스트

- [x] SQL 스크립트 작성
- [x] JavaScript 로직 구현
- [x] CSS 스타일 추가
- [x] ARCHITECTURE.md 업데이트
- [x] 사용자 안내 문구 작성
- [x] 설치 가이드 작성
- [x] 변경 사항 문서화
